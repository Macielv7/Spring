<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Blog - Publica√ß√µes</title>
  <style id="custom-style">
  </style>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./script.js">
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <h1 class="header-title">Publica√ß√µes do Blog</h1>
      <button class="btn btn-primary" id="btn-new">Nova publica√ß√£o</button>
    </header>

    <section id="list" class="post-grid"></section>

    <section id="form" class="form-card" style="display:none">
      <h2 id="form-title" class="form-title">Nova publica√ß√£o</h2>
      <div class="form-group">
        <input type="text" id="titulo" placeholder="T√≠tulo da Publica√ß√£o" class="form-input">
      </div>
      <div class="form-group">
        <textarea id="texto" placeholder="Texto (m√≠nimo 10 caracteres)" class="form-textarea"></textarea>
      </div>
      <div class="form-group-inline">
        <input type="text" id="autor" placeholder="Autor" class="form-input author-input">
        <input type="datetime-local" id="dataPublicacao" class="form-input date-input">
      </div>
      <div class="form-actions">
        <button class="btn btn-success" id="btn-save">Salvar</button>
        <button class="btn btn-secondary" id="btn-cancel">Cancelar</button>
      </div>
      <p class="form-note">A publica√ß√£o com data futura ser√° marcada como n√£o publicada.</p>
    </section>

    <div class="modal-backdrop" id="modal">
      <div class="modal-content">
        <h4 class="modal-title">Confirmar exclus√£o</h4>
        <p>Tem certeza que deseja excluir esta publica√ß√£o?</p>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="modal-cancel">N√£o</button>
          <button class="btn btn-danger" id="modal-confirm">Sim, excluir</button>
        </div>
      </div>
    </div>

    <div class="toast-message" id="toast"></div>
  </div>

  <script>
    const apiBase = '/publicacoes';
    const listEl = document.getElementById('list');
    const formEl = document.getElementById('form');
    const btnNew = document.getElementById('btn-new');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('modal');
    const modalCancel = document.getElementById('modal-cancel');
    const modalConfirm = document.getElementById('modal-confirm');

    let editingId = null;
    let idToDelete = null;

    function showToast(msg) { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }

    async function fetchList() {
      const res = await fetch(apiBase);
      const items = await res.json();
      listEl.innerHTML = '';
      items.forEach(p => {
        const card = document.createElement('div'); card.className = 'post-card';
        const pubDate = p.dataPublicacao ? new Date(p.dataPublicacao) : null;
        const published = pubDate && pubDate <= new Date();
        const statusClass = published ? 'status-published' : 'status-pending';
        const statusText = published ? 'Publicado' : 'Ainda n√£o publicado';
        const dateStr = pubDate ? pubDate.toLocaleString('pt-BR', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
        card.innerHTML = `<h3 class="post-title">${p.titulo}</h3><p class="post-excerpt">${p.texto.substring(0, 150)}${p.texto.length > 150 ? '...' : ''}</p><div class="post-meta"><span class="meta-author">Por **${p.autor}**</span> ‚Ä¢ <span class="meta-date">${dateStr}</span> <span class="post-status ${statusClass}">(${statusText})</span></div>`;
        const actions = document.createElement('div'); actions.className = 'card-actions';
        const btnEdit = document.createElement('button'); btnEdit.className = 'action-btn action-edit'; btnEdit.textContent = '‚úèÔ∏è Editar'; btnEdit.onclick = () => openForm(p);
        const btnDel = document.createElement('button'); btnDel.className = 'action-btn action-delete'; btnDel.textContent = 'üóëÔ∏è Excluir'; btnDel.onclick = () => remove(p.id);
        actions.appendChild(btnEdit); actions.appendChild(btnDel); card.appendChild(actions); listEl.appendChild(card);
      });
    }

    function openForm(p) {
      listEl.style.display = 'none';
      btnNew.style.display = 'none';
      formEl.style.display = 'block';
      editingId = p?.id || null;
      document.getElementById('form-title').textContent = editingId ? 'Editar publica√ß√£o' : 'Nova publica√ß√£o';
      document.getElementById('titulo').value = p?.titulo || '';
      document.getElementById('texto').value = p?.texto || '';
      document.getElementById('autor').value = p?.autor || '';
      document.getElementById('dataPublicacao').value = p?.dataPublicacao ? new Date(p.dataPublicacao).toISOString().slice(0, 16) : '';
    }

    btnNew.onclick = () => openForm();
    btnCancel.onclick = () => {
      formEl.style.display = 'none';
      listEl.style.display = 'grid';
      btnNew.style.display = 'inline-block';
      editingId = null;
    };

    btnSave.onclick = async () => {
      const titulo = document.getElementById('titulo').value.trim();
      const texto = document.getElementById('texto').value.trim();
      const autor = document.getElementById('autor').value.trim();
      const dataPublicacao = document.getElementById('dataPublicacao').value;
      if (!titulo || !texto || !autor || !dataPublicacao) { showToast('Preencha todos os campos'); return; }
      if (texto.length < 10) { showToast('Texto deve ter no m√≠nimo 10 caracteres'); return; }
      const payload = { titulo, texto, autor, dataPublicacao };
      try {
        const method = editingId ? 'PUT' : 'POST';
        const url = editingId ? `${apiBase}/${editingId}` : apiBase;
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (res.ok) {
          showToast('Salvo com sucesso!');
          formEl.style.display = 'none';
          listEl.style.display = 'grid';
          btnNew.style.display = 'inline-block';
          editingId = null;
          fetchList();
        }
        else { const err = await res.text(); showToast(err || 'Erro ao salvar!'); }
      } catch (e) { showToast('Erro ao conectar com a API.'); }
    }

    async function remove(id) {
      idToDelete = id;
      modal.style.display = 'flex';
    }

    modalCancel.onclick = () => { idToDelete = null; modal.style.display = 'none'; };

    modalConfirm.onclick = async () => {
      if (!idToDelete) return;
      try {
        const res = await fetch(`${apiBase}/${idToDelete}`, { method: 'DELETE' });
        const text = await res.text();
        console.log('DELETE', res.status, text);
        if (res.status === 204) {
          showToast('Removido');
          fetchList();
        } else if (res.status === 401 || res.status === 403) {
          showToast('Erro: n√£o autorizado (' + res.status + '). Verifique autentica√ß√£o/CSRF.');
        } else if (res.status >= 400) {
          showToast(text || ('Erro ao excluir (' + res.status + ')'));
        } else {
          showToast('Resposta inesperada: ' + res.status);
        }
      } catch (e) {
        console.error(e);
        showToast('Erro ao conectar');
      }
      idToDelete = null; modal.style.display = 'none';
    }

    fetchList();
  </script>
</body>

</html>