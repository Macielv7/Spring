<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Blog - Publicações</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Publicações do Blog</div>
      <button class="btn" id="btn-new">Nova publicação</button>
    </div>

    <div id="list" class="grid"></div>

    <div id="form" class="form" style="display:none">
      <h3 id="form-title">Nova publicação</h3>
      <div class="row"><input type="text" id="titulo" placeholder="Título"></div>
      <div class="row"><textarea id="texto" placeholder="Texto (mínimo 10 caracteres)"></textarea></div>
      <div class="row"><input type="text" id="autor" placeholder="Autor"></div>
      <div class="row"><input type="datetime-local" id="dataPublicacao"></div>
      <div class="row">
        <button class="btn" id="btn-save">Salvar</button>
        <button class="btn secondary" id="btn-cancel">Cancelar</button>
      </div>
      <div class="footer-note">A publicação com data futura será marcada como não publicada.</div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    const apiBase = '/publicacoes';
    const listEl = document.getElementById('list');
    const formEl = document.getElementById('form');
    const btnNew = document.getElementById('btn-new');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const toast = document.getElementById('toast');

    let editingId = null;

    function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',3000); }

    async function fetchList(){
      const res = await fetch(apiBase);
      const items = await res.json();
      listEl.innerHTML = '';
      items.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<h3>${p.titulo}</h3><p>${p.texto.substring(0,150)}${p.texto.length>150?'...':''}</p><div class="meta">By ${p.autor} • ${new Date(p.dataPublicacao).toLocaleString()} <strong>${p.dataPublicacao? 'Publicado':'Não publicado'}</strong></div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const btnEdit = document.createElement('button'); btnEdit.className='action'; btnEdit.textContent='Editar'; btnEdit.onclick = ()=>openForm(p);
        const btnDel = document.createElement('button'); btnDel.className='action delete'; btnDel.textContent='Excluir'; btnDel.onclick = ()=>remove(p.id);
        actions.appendChild(btnEdit); actions.appendChild(btnDel); card.appendChild(actions); listEl.appendChild(card);
      });
    }

    function openForm(p){
      formEl.style.display='block';
      editingId = p?.id||null;
      document.getElementById('form-title').textContent = editingId? 'Editar publicação' : 'Nova publicação';
      document.getElementById('titulo').value = p?.titulo||'';
      document.getElementById('texto').value = p?.texto||'';
      document.getElementById('autor').value = p?.autor||'';
      if(p?.dataPublicacao) document.getElementById('dataPublicacao').value = new Date(p.dataPublicacao).toISOString().slice(0,16);
    }

    btnNew.onclick = ()=>openForm();
    btnCancel.onclick = ()=>{ formEl.style.display='none'; editingId=null; };

    btnSave.onclick = async ()=>{
      const titulo = document.getElementById('titulo').value.trim();
      const texto = document.getElementById('texto').value.trim();
      const autor = document.getElementById('autor').value.trim();
      const dataPublicacao = document.getElementById('dataPublicacao').value;
      if(!titulo||!texto||!autor||!dataPublicacao){ showToast('Preencha todos os campos'); return; }
      if(texto.length<10){ showToast('Texto deve ter no mínimo 10 caracteres'); return; }
      const payload = {titulo, texto, autor, dataPublicacao};
      try{
        const method = editingId? 'PUT' : 'POST';
        const url = editingId? `${apiBase}/${editingId}` : apiBase;
        const res = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(res.ok){ showToast('Salvo'); formEl.style.display='none'; editingId=null; fetchList(); }
        else{ const err = await res.text(); showToast(err||'Erro'); }
      }catch(e){ showToast('Erro ao conectar'); }
    }

    async function remove(id){ if(!confirm('Excluir?')) return; const res = await fetch(`${apiBase}/${id}`, {method:'DELETE'}); if(res.status===204){ showToast('Removido'); fetchList(); } else { showToast('Erro'); }}

    fetchList();
  </script>
</body>
</html>
